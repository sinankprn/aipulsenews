{% assign max_related = 3 %}
{% assign min_common_tags = 1 %}
{% assign related_posts = "" | split: "" %}

{% for post in site.posts %}
  {% if post.url != page.url %}
    {% assign common_tags = 0 %}
    {% for tag in post.tags %}
      {% if page.tags contains tag %}
        {% assign common_tags = common_tags | plus: 1 %}
      {% endif %}
    {% endfor %}
    {% if common_tags >= min_common_tags %}
      {% assign related_posts = related_posts | push: post %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if related_posts.size == 0 %}
  {% for post in site.posts limit: max_related %}
    {% if post.url != page.url %}
      {% assign related_posts = related_posts | push: post %}
    {% endif %}
  {% endfor %}
{% endif %}

{% assign related_posts = related_posts | slice: 0, max_related %}

{% if related_posts.size > 0 %}
<div class="related-posts">
  <h3 class="related-posts-header">
    <span aria-hidden="true">&#x1F4DA;</span> Related Articles
  </h3>
  <div class="related-posts-grid">
    {% for post in related_posts %}
    <article class="related-post-card">
      <a href="{{ post.url | relative_url }}">
        <h4 class="related-post-title">{{ post.title }}</h4>
        <div class="related-post-meta">
          <time datetime="{{ post.date | date_to_xmlschema }}">{{ post.date | date: "%B %d, %Y" }}</time>
        </div>
      </a>
    </article>
    {% endfor %}
  </div>
</div>
{% endif %}
